name: ğŸ¨ ç·¹ç·¹çš„çµ‚æ¥µæš´åŠ› WebP é­”æ³•

on:
  push:
    branches: [ main ]

jobs:
  optimize-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ è®€å–ä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ å®‰è£ WebP å·¥å…·
        run: sudo apt-get update && sudo apt-get install -y webp

      - name: ğŸ–¼ï¸ åœ–ç‰‡æ¥µè‡´å£“ç¸® (ä¿ç•™åŸå§‹å“è³ª)
        uses: calibreapp/image-actions@main
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          compressOnly: true

      - name: ğŸ åŸ·è¡Œ Python æ·±åº¦è·¯å¾‘æ·¨åŒ–èˆ‡è½‰æª”
        run: |
          python3 -c "
          import os, re, subprocess

          # 1. è½‰æ› WebP æ ¸å¿ƒé‚è¼¯
          img_exts = ('.jpg', '.png', '.jpeg')
          for root, dirs, files in os.walk('.'):
              if '.git' in dirs: dirs.remove('.git')
              for file in files:
                  if file.lower().endswith(img_exts):
                      img_path = os.path.join(root, file)
                      webp_path = os.path.splitext(img_path)[0] + '.webp'
                      if not os.path.exists(webp_path):
                          subprocess.run(['cwebp', '-q', '80', img_path, '-o', webp_path])
                          print(f'âœ… å·²è½‰æ›: {img_path} -> {webp_path}')

          # 2. æš´åŠ›æ›¿æ›è·¯å¾‘ (æ”¯æ´å…¨ç›®éŒ„ã€å¤§å°å¯«ã€å…¨åŸŸåŒ¹é…)
          code_exts = ('.html', '.css', '.js', '.htm', '.json')
          # æ­£å‰‡è¡¨é”å¼ï¼šå°‹æ‰¾ .jpg, .png, .jpeg ä¸¦æ›¿æ›ç‚º .webp
          img_pattern = re.compile(r'\.(jpg|png|jpeg)', re.IGNORECASE)

          for root, dirs, files in os.walk('.'):
              if '.git' in dirs: dirs.remove('.git')
              for file in files:
                  if file.endswith(code_exts):
                      file_path = os.path.join(root, file)
                      with open(file_path, 'r', encoding='utf-8') as f:
                          content = f.read()
                      
                      new_content = img_pattern.sub('.webp', content)
                      
                      if content != new_content:
                          with open(file_path, 'w', encoding='utf-8') as f:
                              f.write(new_content)
                          print(f'âœ¨ å·²æš´åŠ›æ·¨åŒ–æª”æ¡ˆ: {file_path}')
          "

      - name: ğŸš€ å¼·åŠ›éƒ¨ç½²åˆ° GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: .
          branch: gh-pages
          clean: true
