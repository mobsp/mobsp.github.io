name: ğŸ¨ ç·¹ç·¹çš„çµ‚æ¥µæš´åŠ›ç¾å­¸ï¼šWebP + æ­·å²ç´€éŒ„

on:
  push:
    branches: [ main ]

jobs:
  optimize-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ è®€å–ä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å¿…é ˆè¨­å®šç‚º 0 æ‰èƒ½æŠ“åˆ°å®Œæ•´çš„ Git æ­·å²

      - name: ğŸ› ï¸ å®‰è£ WebP å·¥å…·
        run: sudo apt-get update && sudo apt-get install -y webp

      - name: ğŸ åŸ·è¡Œ Python æ·±åº¦è·¯å¾‘æ·¨åŒ–èˆ‡è½‰æª”
        run: |
          python3 -c "
          import os, re, subprocess

          # 1. è½‰æ› WebP
          img_exts = ('.jpg', '.png', '.jpeg')
          for root, dirs, files in os.walk('.'):
              if '.git' in dirs: dirs.remove('.git')
              for file in files:
                  if file.lower().endswith(img_exts):
                      img_path = os.path.join(root, file)
                      webp_path = os.path.splitext(img_path)[0] + '.webp'
                      if not os.path.exists(webp_path):
                          subprocess.run(['cwebp', '-q', '80', img_path, '-o', webp_path])
          
          # 2. æš´åŠ›æ›¿æ›ä»£ç¢¼ä¸­çš„åœ–ç‰‡è·¯å¾‘
          code_exts = ('.html', '.css', '.js', '.htm', '.json')
          img_pattern = re.compile(r'\.(jpg|png|jpeg)', re.IGNORECASE)
          for root, dirs, files in os.walk('.'):
              for file in files:
                  if file.endswith(code_exts):
                      file_path = os.path.join(root, file)
                      with open(file_path, 'r', encoding='utf-8') as f:
                          content = f.read()
                      new_content = img_pattern.sub('.webp', content)
                      if content != new_content:
                          with open(file_path, 'w', encoding='utf-8') as f:
                              f.write(new_content)
          "

      - name: ğŸ“œ è‡ªå‹•ç”Ÿæˆæ­·å²ç´€éŒ„ (history.html)
        run: |
          echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>ç³»çµ±é€²åŒ–æ—¥èªŒ</title><link rel="stylesheet" href="style.css"></head><body>' > history.html
          echo '<div class="container"><h1>ğŸš€ ç³»çµ±é€²åŒ–æ—¥èªŒ</h1><ul class="timeline">' >> history.html
          # æ ¼å¼åŒ– Git Logï¼šæ—¥æœŸ - è¨Šæ¯
          git log -n 15 --pretty=format:"<li><span class='date'>%ad</span><span class='msg'>%s</span></li>" --date=short >> history.html
          echo '</ul><a href="index.html" class="back-btn">â† è¿”å›ä¸»é </a></div></body></html>' >> history.html

      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: .
          branch: gh-pages
          clean: true
