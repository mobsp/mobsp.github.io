name: ğŸ¨ ç·¹ç·¹çš„ WebP ä¸€éµé­”æ³•

on:
  push:
    branches: [ main ] # ç•¶ä½ æ¨é€åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼

jobs:
  optimize-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ è®€å–ä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ å®‰è£ WebP å·¥å…·
        run: sudo apt-get update && sudo apt-get install -y webp

      - name: ğŸ–¼ï¸ è½‰æ›åœ–ç‰‡ä¸¦æ”¹å¯«è·¯å¾‘ (å¤©æ‰æ–¹æ¡ˆ)
        run: |
          # 1. å°‹æ‰¾æ‰€æœ‰ jpg/png åœ–ç‰‡ä¸¦è½‰æ›ç‚º webpï¼Œä¿ç•™åŸå§‹æª”åä½œç‚ºå‰ç¶´
          # ä¾‹å¦‚: photo.jpg -> photo.webp
          find . -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" \) | while read img; do
            if [ ! -f "${img%.*}.webp" ]; then
              cwebp -q 80 "$img" -o "${img%.*}.webp"
              echo "âœ… å·²è½‰æ›: $img -> ${img%.*}.webp"
            fi
          done

          # 2. è‡ªå‹•æ”¹å¯« HTML/CSS/JS è£¡é¢çš„è·¯å¾‘
          # æˆ‘å€‘æœƒæŠŠæ‰€æœ‰ .jpg, .png, .jpeg çš„å¼•ç”¨æ›æˆ .webp
          # ä½¿ç”¨ sed çš„ç²¾ç¢ºæ›¿æ›ï¼Œé¿å…èª¤å‚·
          echo "ğŸª„ æ­£åœ¨æ–½å±•è·¯å¾‘æ›¿æ›é­”æ³•..."
          find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) -exec sed -i -E 's/\.(jpg|png|jpeg)/.webp/g' {} +

      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: . # éƒ¨ç½²ç›®å‰æ•´å€‹ç›®éŒ„
          branch: gh-pages # é€™æ˜¯ä½ çš„ Pages åˆ†æ”¯
          clean: true
